{% extends "base.html" %}

{% block title %}Perfil de {{ cliente.nombre }}{% endblock %}

{% block content %}
    <h2>Perfil del Cliente</h2>

    <div class="profile-card">
        <h3>{{ cliente.nombre }}</h3>
        <p><strong>DNI:</strong> {{ cliente.dni or 'No registrado' }}</p>
        <p><strong>Correo:</strong> {{ cliente.correo or 'No registrado' }}</p>
        <p><strong>Celular:</strong> {{ cliente.celular or 'No registrado' }}</p>
        <p><strong>G√©nero:</strong> {{ cliente.genero or 'No registrado' }}</p>
        <p><strong>Curso de Inter√©s:</strong> {{ cliente.curso_interes or 'No especificado' }}</p>
        <p><strong>Asesor Asignado:</strong> {{ cliente.asesor_asignado or 'No asignado' }}</p>
        <p><strong>Estado:</strong> <span class="status-{{ cliente.estado }}">{{ cliente.estado|capitalize }}</span></p>

        <div class="tags-section">
            <strong>Etiquetas:</strong>
            <div class="tags-container">
                {% for etiqueta in etiquetas_cliente %}
                    <span class="tag">
                        {{ etiqueta.nombre }}
                        <a href="{{ url_for('quitar_etiqueta', cliente_id=cliente.id, etiqueta_id=etiqueta.id) }}" class="remove-tag" title="Quitar etiqueta">√ó</a>
                    </span>
                {% else %}
                    <span class="no-tags">Sin etiquetas asignadas.</span>
                {% endfor %}
            </div>
            <form method="POST" class="tag-form">
                <input type="hidden" name="form_type" value="etiqueta">
                <input type="text" name="nombre_etiqueta" placeholder="A√±adir nueva etiqueta..." autocomplete="off">
                <button type="submit">A√±adir</button>
            </form>
        </div>
    </div>

    <div class="activity-section">
        
        <div class="activity-forms-container">
            <h3>Registrar Seguimiento</h3>
            <form method="POST" class="interaction-form">
                <input type="hidden" name="form_type" value="seguimiento">
                <label for="tipo_interaccion">Tipo:</label>
                <select name="tipo_interaccion" required>
                    <option value="">-- Seleccionar Tipo --</option>
                    <option value="Llamada">Llamada</option>
                    <option value="WhatsApp">WhatsApp</option>
                    <option value="Email">Email</option>
                    <option value="Revisi√≥n de Pago">Revisi√≥n de Pago</option>
                    <option value="Soporte">Soporte</option>
                    <option value="Otro">Otro</option>
                </select>
                
                <label for="comentarios">Comentarios (Notas):</label>
                <textarea name="comentarios" placeholder="Escribe aqu√≠ los detalles del contacto o la tarea pendiente..." required></textarea>
                <button type="submit">Guardar Seguimiento</button>
            </form>
        </div>

        <div class="activity-history-container">
            <h3>Historial de Seguimientos</h3>
            <div class="table-container-modern">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th class="col-accion">Acci√≥n</th>
                            <th class="col-estado">Estado</th>
                            <th>Tipo</th>
                            <th class="col-comentarios">Comentarios</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Fecha Atenci√≥n</th>
                            <th>Asesor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historial %}
                        <tr>
                            <td class="actions-cell">
                                {% if item.estado == 'Por Atender' %}
                                <form action="{{ url_for('atender_seguimiento', seguimiento_id=item.id) }}" method="POST" class="action-form">
                                    <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
                                    <button class="btn-icon btn-atender" title="Marcar como Atendido">‚úÖ</button>
                                </form>
                                {% endif %}
                                <form action="{{ url_for('eliminar_seguimiento', seguimiento_id=item.id) }}" method="POST" class="action-form" onsubmit="return confirm('¬øEliminar este seguimiento?');">
                                    <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
                                    <button class="btn-icon btn-eliminar" title="Eliminar Seguimiento">üóëÔ∏è</button>
                                </form>
                            </td>
                            <td class="status-cell">
                                {% if item.estado == 'Atendido' %}
                                    <span class="status-dot status-atendido" title="Atendido"></span>
                                {% else %}
                                    <span class="status-dot status-por-atender" title="Por Atender"></span>
                                {% endif %}
                            </td>
                            <td>{{ item.tipo_interaccion }}</td>
                            <td class="comentarios-cell">{{ item.comentarios }}</td>
                            <td>{{ item.fecha_creacion.strftime('%d/%m/%y %H:%M') }}</td>
                            <td>
                                {% if item.fecha_atencion %}
                                    {{ item.fecha_atencion.strftime('%d/%m/%y %H:%M') }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>{{ item.asesor_nombre }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" style="text-align: center;">No hay seguimientos registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <h3>Historial de Pagos</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID Pago</th> <th>Fecha</th> <th>Cuota</th> <th>Tipo</th>
                    <th>N¬∞ Operaci√≥n</th> <th>Especialidad</th> <th>Asesor</th> <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for pago in pagos %}
                <tr>
                    <td>{{ pago.id }}</td>
                    <td>{{ pago.fecha.strftime('%Y-%m-%d') if pago.fecha }}</td>
                    <td>S/ {{ "%.2f"|format(pago.cuota or 0) }}</td>
                    <td>{{ pago.tipo_de_cuota }}</td>
                    <td>{{ pago.numero_operacion }}</td>
                    <td>{{ pago.especialidad }}</td>
                    <td>{{ pago.asesor }}</td>
                    <td class="actions">
                        <a href="{{ url_for('editar', id=pago.id) }}" class="action-icon" title="Editar Pago">‚úèÔ∏è</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align:center;">Este cliente no tiene pagos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block styles %}
<style>
    /* Estilos de Perfil y Etiquetas (Sin cambios) */
    .profile-card { background: white; padding: 25px; border-radius: 10px; max-width: 800px; margin: 20px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .profile-card h3 { color: #004080; margin-top: 0; }
    .profile-card p { margin: 8px 0; }
    .status-activo { color: #28a745; font-weight: bold; }
    .status-potencial { color: #ffc107; font-weight: bold; }
    .status-inactivo { color: #dc3545; font-weight: bold; }
    .tags-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .tag { background-color: #007bff; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; display: inline-flex; align-items: center; }
    .remove-tag { color: white; text-decoration: none; margin-left: 8px; font-weight: bold; font-size: 1.2em; line-height: 1; }
    .tag-form { display: flex; margin-top: 15px; gap: 10px; }
    .tag-form input { flex: 1; }
    .tag-form button { padding: 8px 15px; margin-top: 0; width: auto; }

    /* Estilos de la Secci√≥n de Actividades (Sin cambios) */
    .activity-section { display: flex; flex-wrap: wrap; gap: 30px; max-width: 1200px; margin: 40px auto; }
    .activity-forms-container { flex: 1; min-width: 350px; max-width: 400px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; height: fit-content; }
    .activity-history-container { flex: 3; min-width: 500px; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .activity-history-container h3, .activity-forms-container h3 { color: #004080; margin-top: 0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
    .interaction-form label { margin-top: 10px; font-weight: 600; }
    .interaction-form select, .interaction-form textarea { width: 100%; margin-bottom: 15px; }
    .interaction-form textarea { min-height: 100px; resize: vertical; }
    .interaction-form button { width: 100%; margin-top: 10px; }

    /* ‚úÖ NUEVOS ESTILOS PARA LA TABLA DE HISTORIAL MODERNA */
    .table-container-modern {
        overflow-x: auto;
    }
    .history-table {
        width: 100%;
        border-collapse: collapse;
    }
    .history-table th, .history-table td {
        padding: 12px 10px;
        text-align: left;
        border-bottom: 1px solid #dee2e6; /* L√≠neas horizontales suaves */
        vertical-align: middle;
        font-size: 0.9em;
    }
    .history-table th {
        font-weight: 600;
        color: #ffffff;
        background-color: #004080;
        white-space: nowrap;
    }
    .history-table .col-comentarios {
        width: 35%; /* M√°s espacio para comentarios */
        white-space: pre-wrap;
    }
    .history-table .col-accion { width: 80px; text-align: center; }
    .history-table .col-estado { width: 30px; text-align: center; }
    
    /* C√©lula de Acciones (Botones) */
    .actions-cell {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    .action-form {
        margin: 0;
        padding: 0;
        background: none;
        box-shadow: none;
    }
    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        font-size: 1.3em; /* Iconos m√°s grandes */
        transition: transform 0.2s ease;
    }
    .btn-icon:hover {
        transform: scale(1.3);
    }
    .btn-atender { color: #28a745; }
    .btn-eliminar { color: #dc3545; }

    /* C√©lula de Estado (Punto) */
    .status-cell {
        padding-right: 0px !important; /* Ajuste fino */
    }
    .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    .status-atendido {
        background-color: #28a745;
    }
    .status-por-atender {
        background-color: #fd7e14;
    }
</style>
{% endblock %}